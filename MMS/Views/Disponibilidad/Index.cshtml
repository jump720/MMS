@model MMS.Models.ItemDisponibilidad

@{
    string controllerName = ViewContext.RouteData.Values["controller"].ToString();
    ViewBag.Title = "Stock";
    ViewBag.Subtitle = "List";
    Layout = "~/Views/Shared/_LayoutTT.cshtml";
    MMS.Models.DisponibilidadArchivo daModel = null;
}

@section Styles
{
    @Styles.Render("~/bundles/cssDataTables")
    @Styles.Render("~/bundles/cssSelect2")
}

@section Scripts
{
    @Scripts.Render("~/bundles/jsDataTables")
    @Scripts.Render("~/bundles/jsSelect2")
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">
        $(document).ready(function () {

            $("#ColeccionPIV").select2({
                placeholder: "Select PIP Collection",
                allowClear: true,
                theme: "bootstrap",
            });

            $("#Marca").select2({
                placeholder: "Select Brand",
                allowClear: true,
                theme: "bootstrap",
            });

            $('[data-toggle="tooltip"]').tooltip();

            dt = dataTablesIndex("tableDT", "/api/@controllerName/Index", "/@controllerName/Index",
                [
                    { data: "ColeccionPIV.Nombre" },
                    { data: "Item.Marca" },
                    { data: "Item.Codigo" },
                    { data: "Item.Descripcion" },
                    {
                        data: "Cantidad",
                        render: function (value) {
                            return `<div class="text-right">${value.formatMoney(0)}</div>`;
                        }
                    },
                    {
                        render: function (value, npi, full) {
                            return `<a href='/@controllerName/Detalle/${full.ColeccionPIV.Id}?itemId=${full.Item.Id}' onclick="ajaxModal(event, this.href, 4)" class='btn-table btn-primary btn-sm btn-sm-circle waves-circle waves-effect waves-float' data-toggle="tooltip" data-placement="top" title="Detail"><i class='material-icons'>list</i></a>`;
                        }
                    }
                ],
                {
                    mainFilter: false,
                    filterControls: ["ColeccionPIV", "Marca", "txtBuscarCodigo", "txtBuscarDescripcion"],
                    fnServerParams: function () {
                        return [
                            { name: "_coleccionPIVId", value: $('#ColeccionPIV').val() },
                            { name: "_marcaId", value: $('#Marca').val() },
                            { name: "_codigo", value: $('#txtBuscarCodigo').val() },
                            { name: "_descripcion", value: $('#txtBuscarDescripcion').val() },
                        ];
                    }
                });
            
            $("#frmUploadStock").submit(function (e) {
                e.preventDefault();

                if (!$(this).valid())
                    return;

                var data = new FormData();
                data.append("File", $("#File").get(0).files[0]);

                sLoading();
                $.ajax({
                    type: this.method,
                    url: this.action + "?mes=" + $("#daModel_Mes").val() + "&ano=" + $("#daModel_Ano").val(),
                    contentType: false,
                    processData: false,
                    data: data,
                    success: function (result) {
                        if (result.Res) {
                            $("#frmUploadStock .modal").modal("hide");
                            msgSuccess(`File uploaded.`);
                            dt.api().draw('page');
                        }
                        else {
                            if (result.Msg == "validation") {
                                msgError("Validation errors were found.");
                                console.log(result.Data);

                                $("#frmUploadStock .modal-dialog").addClass("modal-lg");

                                $("#uploadFileContent").animateCss("bounceOut", function (animated) {
                                    $(animated).hide();
                                    $("#validationErrorsContent").show();
                                    $("#validationErrorsContent").animateCss("bounceIn");
                                });

                                var errors = '<ul style="max-height: 80vh;overflow-y: auto;">';
                                for (var i in result.Data)
                                    errors += "<li>" + result.Data[i] + "</li>";

                                errors += "</ul>"
                                $("#validationErrorsContent .modal-body").html(errors);
                            }
                            else
                                msgError(result.Msg);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        msgError(errorThrown);
                    },
                    complete: function () {
                        hLoading();
                    }
                });
            });
        });

        function uploadStockFileModal() {
            var now = new Date();
            $("#daModel_Mes").val(now.getMonth() + 1);
            $("#daModel_Ano").val(now.getFullYear());
            $("#File").val("");
            $("#uploadFileContent").show();
            $("#validationErrorsContent").hide();
            $("#frmUploadStock .modal-dialog").removeClass("modal-lg");
            $("#frmUploadStock .modal").modal();
        }
    </script>
}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="header bg-blue">
                <table>
                    <tr>
                        <td>
                            <a href="javascript:void(0)" onclick="uploadStockFileModal()" data-toggle="tooltip" data-placement="bottom" title="Add Stock" class="btn btn-default btn-circle waves-effect waves-circle waves-float @ViewData[$"has_{controllerName}Upload"]" onclick="redirtWithReturnSearch(this, event);">
                                <i class="material-icons" style="color:black !important">add</i>
                            </a>
                        </td>
                        <td style="padding-left: 10px">
                            <h2>
                                @ViewBag.Title <small>@ViewBag.Subtitle</small>
                            </h2>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="body">
                <table id="tableDT" class="table table-bordered table-striped table-hover dataTable table-condensed table-va-middle">
                    <thead>
                        <tr>
                            <th width="20%">
                                @Html.DisplayNameFor(model => model.ColeccionPIVId)
                            </th>
                            <th width="15%">
                                @Html.DisplayNameFor(model => model.Item.MarcaId)
                            </th>
                            <th width="10%">
                                @Html.DisplayNameFor(model => model.Item.Codigo)
                            </th>
                            <th width="40%">
                                @Html.DisplayNameFor(model => model.Item.Descripcion)
                            </th>
                            <th style="text-align: right;">
                                @Html.DisplayNameFor(model => model.Cantidad)
                            </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <th>
                                @Html.DropDownList("ColeccionPIV", null, "", new { @class = "ms full-width" })
                            </th>
                            <th>
                                @Html.DropDownList("Marca", null, "", new { @class = "ms full-width" })
                            </th>
                            <th>
                                <div class="form-group">
                                    <div class="form-line">
                                        <input type="text" id="txtBuscarCodigo" class="form-control" style="width: 100%;" placeholder="Search @Html.DisplayNameFor(model => model.Item.Codigo)" />
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="form-group">
                                    <div class="form-line">
                                        <input type="text" id="txtBuscarDescripcion" class="form-control" style="width: 100%;" placeholder="Search @Html.DisplayNameFor(model => model.Item.Descripcion)" />
                                    </div>
                                </div>
                            </th>
                            <th></th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<form action="/api/@controllerName/Upload" method="post" novalidate="novalidate" id="frmUploadStock">
    <div class="modal fade" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div id="uploadFileContent">
                    <div class="modal-header">
                        <h4 class="modal-title">Upload Stock File</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row clearfix">

                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="form-line">
                                        @Html.LabelFor(model => daModel.Mes, new { @class = "form-select-label" })
                                        @Html.DropDownListFor(model => daModel.Mes, null, "- Month -", new { @class = "ms form-control" })
                                    </div>
                                    @Html.ValidationMessageFor(model => daModel.Mes, "", new { @class = "" })
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    <div class="form-line">
                                        @Html.LabelFor(model => daModel.Ano, new { @class = "form-select-label" })
                                        @Html.DropDownListFor(model => daModel.Ano, null, "- Year -", new { @class = "ms form-control" })
                                    </div>
                                    @Html.ValidationMessageFor(model => daModel.Ano, "", new { @class = "" })
                                </div>
                            </div>

                            <div class="col-md-12">
                                <input type="file" name="File" id="File" accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" data-val="true" data-val-required="The File field is required." />
                                @Html.ValidationMessage("File", new { @class = "" })
                            </div>

                        </div>
                    </div>

                    <hr class="m-b-0 m-t--5" />

                    <div class="modal-footer">
                        <a href="/Disponibilidad/BaseFile" target="_blank" class="btn btn-success waves-effect pull-left">Download Base File</a>
                        <button type="submit" class="btn btn-primary waves-effect">Upload</button>
                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancel</button>
                    </div>
                </div>

                <div id="validationErrorsContent" style="display: none;">
                    <div class="modal-header">
                        <button type="button" class="close btn-link" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Validation Errors</h4>
                    </div>
                    <div class="modal-body">

                    </div>
                </div>

            </div>
        </div>
    </div>
</form>